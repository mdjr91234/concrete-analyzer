<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Pricing Adjustments - Step 5</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .progress-bar {
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            width: 83.33%; /* Step 5 of 6 */
            transition: width 0.3s ease;
        }

        .content {
            padding: 40px;
        }

        /* Profit Gap Summary */
        .profit-gap-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid #dee2e6;
        }

        .profit-gap-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .profit-gap-header h2 {
            color: #2c3e50;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .profit-thermometer {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            gap: 30px;
        }

        .thermometer-container {
            position: relative;
            width: 80px;
            height: 300px;
            background: #ecf0f1;
            border-radius: 40px;
            border: 3px solid #bdc3c7;
            overflow: hidden;
        }

        .thermometer-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(0deg, #e74c3c 0%, #f39c12 50%, #27ae60 100%);
            border-radius: 40px 40px 0 0;
            transition: height 0.8s ease;
        }

        .thermometer-labels {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 300px;
            margin-left: 15px;
        }

        .thermometer-label {
            background: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .profit-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .profit-metric {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .profit-metric .value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .profit-metric .label {
            color: #7f8c8d;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .gap-indicator {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
            text-align: center;
        }

        .gap-indicator.deficit {
            background: #fdf2f2;
            color: #e74c3c;
            border: 2px solid #f5c6cb;
        }

        .gap-indicator.surplus {
            background: #f0f9f0;
            color: #27ae60;
            border: 2px solid #c3e6cb;
        }

        /* Customer Analytics Overview */
        .analytics-overview {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .analytics-overview h3 {
            color: #2c3e50;
            font-size: 1.4rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }

        .customer-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .customer-stat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #3498db;
        }

        .customer-stat .stat-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .customer-stat .stat-label {
            font-size: 0.85rem;
            color: #7f8c8d;
            font-weight: 500;
        }

        /* Main Content Grid */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            margin-top: 30px;
        }

        /* Bucket Management */
        .bucket-management {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .bucket-management h3 {
            color: #2c3e50;
            font-size: 1.4rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .create-bucket-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .create-bucket-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .buckets-container {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .bucket-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .bucket-card:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .bucket-card.active-drop-zone {
            border-color: #27ae60;
            background: #f0f9f0;
            border-style: dashed;
        }

        .bucket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .bucket-name {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1rem;
        }

        .bucket-actions {
            display: flex;
            gap: 5px;
        }

        .bucket-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            transition: background 0.2s ease;
        }

        .bucket-action-btn:hover {
            background: #dee2e6;
        }

        .bucket-criteria {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .bucket-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            font-size: 0.8rem;
        }

        .bucket-stat {
            text-align: center;
            padding: 5px;
            background: white;
            border-radius: 4px;
        }

        .bucket-stat .value {
            font-weight: bold;
            color: #2c3e50;
        }

        .bucket-stat .label {
            color: #7f8c8d;
            margin-top: 2px;
        }

        /* Customer Assignment Area */
        .customer-assignment {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .customer-assignment h3 {
            color: #2c3e50;
            font-size: 1.4rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .assignment-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .search-box:focus {
            outline: none;
            border-color: #3498db;
        }

        .filter-select {
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            background: white;
            cursor: pointer;
        }

        .customers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .customer-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            cursor: grab;
            transition: all 0.3s ease;
            user-select: none;
        }

        .customer-card:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .customer-card:active {
            cursor: grabbing;
        }

        .customer-card.assigned {
            background: #e8f5e8;
            border-color: #27ae60;
        }

        .customer-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .customer-name {
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.95rem;
        }

        .assignment-status {
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        .assignment-status.unassigned {
            background: #fef2e0;
            color: #f39c12;
        }

        .assignment-status.assigned {
            background: #e8f5e8;
            color: #27ae60;
        }

        .assignment-status.conflict {
            background: #fdf2f2;
            color: #e74c3c;
        }

        .customer-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            font-size: 0.8rem;
        }

        .customer-metric {
            text-align: center;
            padding: 5px;
            background: white;
            border-radius: 4px;
        }

        .customer-metric .value {
            font-weight: bold;
            color: #2c3e50;
        }

        .customer-metric .label {
            color: #7f8c8d;
            margin-top: 2px;
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Progress Tracking */
        .progress-tracking {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .progress-tracking h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .progress-ring-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .progress-ring {
            width: 120px;
            height: 120px;
            position: relative;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .progress-ring-circle {
            fill: none;
            stroke-width: 8;
        }

        .progress-ring-circle.bg {
            stroke: #ecf0f1;
        }

        .progress-ring-circle.progress {
            stroke: #3498db;
            stroke-linecap: round;
            stroke-dasharray: 314.16;
            stroke-dashoffset: 314.16;
            transition: stroke-dashoffset 0.5s ease;
        }

        .progress-ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .progress-details {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .progress-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        /* Overlap Resolution */
        .overlap-resolution {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .overlap-resolution h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .conflicts-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .conflict-item {
            background: #fdf2f2;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .conflict-customer {
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 5px;
        }

        .conflict-options {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .resolve-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        /* Pricing Impact */
        .pricing-impact {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .pricing-impact h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .impact-summary {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .impact-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .impact-value {
            font-weight: bold;
        }

        .impact-value.positive {
            color: #27ae60;
        }

        .impact-value.negative {
            color: #e74c3c;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .criteria-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        /* Navigation */
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .nav-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .nav-btn.back {
            background: #6c757d;
            color: white;
        }

        .nav-btn.back:hover {
            background: #5a6268;
            transform: translateX(-3px);
        }

        .nav-btn.continue {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .nav-btn.continue:hover {
            transform: translateX(3px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .nav-btn:disabled {
            background: #dee2e6;
            color: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .profit-thermometer {
                flex-direction: column;
                gap: 20px;
            }
            
            .thermometer-container {
                width: 60px;
                height: 200px;
            }
            
            .profit-metrics {
                grid-template-columns: 1fr;
            }
            
            .customers-grid {
                grid-template-columns: 1fr;
            }
            
            .navigation {
                flex-direction: column;
                gap: 15px;
            }
            
            .sidebar {
                display: block;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .modal {
                width: 95%;
                padding: 20px;
            }
            
            .customer-metrics {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Animation Classes */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Step 5: Customer Pricing Adjustments</h1>
            <p>Categorize customers and apply targeted pricing strategies to achieve your profit goals</p>
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
        </div>

        <div class="content">
            <!-- Profit Gap Summary -->
            <div class="profit-gap-section fade-in">
                <div class="profit-gap-header">
                    <h2>Profit Gap Analysis</h2>
                    <p>Current profit gap that needs to be addressed through pricing adjustments</p>
                </div>

                <div class="profit-thermometer">
                    <div class="thermometer-container">
                        <div class="thermometer-fill" id="profitThermometerFill"></div>
                    </div>
                    <div class="thermometer-labels">
                        <div class="thermometer-label" id="goalLabel">Goal: $0</div>
                        <div class="thermometer-label" id="projectedLabel">Projected: $0</div>
                        <div class="thermometer-label" id="currentLabel">Current: $0</div>
                    </div>
                </div>

                <div class="profit-metrics">
                    <div class="profit-metric">
                        <div class="value" id="goalProfit">$0.00</div>
                        <div class="label">Goal Profit</div>
                    </div>
                    <div class="profit-metric">
                        <div class="value" id="projectedProfit">$0.00</div>
                        <div class="label">Projected Profit</div>
                    </div>
                    <div class="profit-metric">
                        <div class="value" id="profitGap">$0.00</div>
                        <div class="label">Profit Gap</div>
                    </div>
                    <div class="profit-metric">
                        <div class="value" id="gapPercentage">0.0%</div>
                        <div class="label">Gap Percentage</div>
                    </div>
                </div>

                <div class="gap-indicator" id="gapIndicator">
                    <span id="gapMessage">Set your goals in previous steps to see gap analysis</span>
                </div>
            </div>

            <!-- Customer Analytics Overview -->
            <div class="analytics-overview fade-in">
                <h3>Customer Analytics Overview</h3>
                <div class="customer-stats-grid">
                    <div class="customer-stat">
                        <div class="stat-value" id="totalCustomers">0</div>
                        <div class="stat-label">Total Customers</div>
                    </div>
                    <div class="customer-stat">
                        <div class="stat-value" id="avgVolume">0</div>
                        <div class="stat-label">Avg Volume (yd³)</div>
                    </div>
                    <div class="customer-stat">
                        <div class="stat-value" id="avgPrice">$0.00</div>
                        <div class="stat-label">Avg Unit Price</div>
                    </div>
                    <div class="customer-stat">
                        <div class="stat-value" id="avgMargin">0.0%</div>
                        <div class="stat-label">Avg Margin</div>
                    </div>
                    <div class="customer-stat">
                        <div class="stat-value" id="totalRevenue">$0.00</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    <div class="customer-stat">
                        <div class="stat-value" id="totalVolumeStat">0</div>
                        <div class="stat-label">Total Volume (yd³)</div>
                    </div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="main-content">
                <!-- Left Column: Bucket Management and Customer Assignment -->
                <div class="left-column">
                    <!-- Bucket Management -->
                    <div class="bucket-management fade-in">
                        <h3>
                            Customer Buckets
                            <button class="create-bucket-btn" onclick="showCreateBucketModal()">
                                + Create Bucket
                            </button>
                        </h3>
                        <div class="buckets-container" id="bucketsContainer">
                            <!-- Buckets will be dynamically added here -->
                        </div>
                    </div>

                    <!-- Customer Assignment -->
                    <div class="customer-assignment fade-in">
                        <h3>Customer Assignment</h3>
                        <div class="assignment-controls">
                            <input type="text" class="search-box" id="customerSearch" placeholder="Search customers...">
                            <select class="filter-select" id="statusFilter">
                                <option value="all">All Customers</option>
                                <option value="unassigned">Unassigned</option>
                                <option value="assigned">Assigned</option>
                                <option value="conflict">Conflicts</option>
                            </select>
                            <button class="btn btn-secondary" onclick="showBulkAssignModal()">Bulk Assign</button>
                        </div>
                        <div class="customers-grid" id="customersGrid">
                            <!-- Customer cards will be dynamically added here -->
                        </div>
                    </div>
                </div>

                <!-- Right Column: Sidebar -->
                <div class="sidebar">
                    <!-- Progress Tracking -->
                    <div class="progress-tracking fade-in">
                        <h4>Categorization Progress</h4>
                        <div class="progress-ring-container">
                            <div class="progress-ring">
                                <svg>
                                    <circle class="progress-ring-circle bg" cx="60" cy="60" r="50"></circle>
                                    <circle class="progress-ring-circle progress" cx="60" cy="60" r="50" id="progressCircle"></circle>
                                </svg>
                                <div class="progress-ring-text" id="progressPercentage">0%</div>
                            </div>
                        </div>
                        <div class="progress-details">
                            <div class="progress-detail">
                                <span>Assigned:</span>
                                <span id="assignedCount">0</span>
                            </div>
                            <div class="progress-detail">
                                <span>Unassigned:</span>
                                <span id="unassignedCount">0</span>
                            </div>
                            <div class="progress-detail">
                                <span>Conflicts:</span>
                                <span id="conflictCount">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Overlap Resolution -->
                    <div class="overlap-resolution fade-in">
                        <h4>Overlap Resolution</h4>
                        <div class="conflicts-list" id="conflictsList">
                            <p style="text-align: center; color: #7f8c8d; font-style: italic;">No conflicts detected</p>
                        </div>
                    </div>

                    <!-- Pricing Impact -->
                    <div class="pricing-impact fade-in">
                        <h4>Pricing Impact Summary</h4>
                        <div class="impact-summary">
                            <div class="impact-metric">
                                <span>Revenue Change:</span>
                                <span class="impact-value" id="revenueChange">$0.00</span>
                            </div>
                            <div class="impact-metric">
                                <span>Profit Change:</span>
                                <span class="impact-value" id="profitChange">$0.00</span>
                            </div>
                            <div class="impact-metric">
                                <span>Goal Achievement:</span>
                                <span class="impact-value" id="goalAchievement">0%</span>
                            </div>
                            <div class="impact-metric">
                                <span>Customers Affected:</span>
                                <span class="impact-value" id="customersAffected">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="navigation">
                <button class="nav-btn back" onclick="goToStep(4)">← Back to Summary</button>
                <div style="text-align: center;">
                    <div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">
                        Complete customer categorization to continue
                    </div>
                    <div style="font-size: 0.8rem; color: #6c757d;">
                        Minimum 70% required
                    </div>
                </div>
                <button class="nav-btn continue" id="continueBtn" onclick="goToStep(6)" disabled>
                    Continue to Final Results →
                </button>
            </div>
        </div>
    </div>

    <!-- Create Bucket Modal -->
    <div class="modal-overlay" id="createBucketModal">
        <div class="modal">
            <h3>Create Customer Bucket</h3>
            <form id="createBucketForm">
                <div class="form-group">
                    <label for="bucketName">Bucket Name</label>
                    <input type="text" id="bucketName" placeholder="e.g., High Volume Premium" required>
                </div>
                
                <div class="form-group">
                    <label>Volume Range (Cubic Yards)</label>
                    <div class="criteria-range">
                        <input type="number" id="volumeMin" placeholder="Min" min="0" step="0.1">
                        <input type="number" id="volumeMax" placeholder="Max (leave empty for unlimited)" min="0" step="0.1">
                    </div>
                </div>

                <div class="form-group">
                    <label>Unit Price Range ($/yd³)</label>
                    <div class="criteria-range">
                        <input type="number" id="priceMin" placeholder="Min" min="0" step="0.01">
                        <input type="number" id="priceMax" placeholder="Max (leave empty for unlimited)" min="0" step="0.01">
                    </div>
                </div>

                <div class="form-group">
                    <label>Profit Margin Range (%)</label>
                    <div class="criteria-range">
                        <input type="number" id="marginMin" placeholder="Min" min="-100" max="200" step="0.1">
                        <input type="number" id="marginMax" placeholder="Max (leave empty for unlimited)" min="-100" max="200" step="0.1">
                    </div>
                </div>

                <div class="form-group">
                    <label for="priceAdjustment">Price Adjustment ($/yd³)</label>
                    <input type="number" id="priceAdjustment" placeholder="e.g., 5.00 for $5 increase" step="0.01">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createBucketModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Bucket</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Assign Modal -->
    <div class="modal-overlay" id="bulkAssignModal">
        <div class="modal">
            <h3>Bulk Assignment</h3>
            <div class="form-group">
                <label for="bulkTargetBucket">Assign all unassigned customers to:</label>
                <select id="bulkTargetBucket" required>
                    <option value="">Select a bucket...</option>
                </select>
            </div>
            <div style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                <span id="bulkAssignPreview">0 customers will be assigned</span>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('bulkAssignModal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="executeBulkAssign()">Assign Customers</button>
            </div>
        </div>
    </div>

    <!-- Conflict Resolution Modal -->
    <div class="modal-overlay" id="conflictModal">
        <div class="modal">
            <h3>Resolve Assignment Conflict</h3>
            <div id="conflictContent">
                <!-- Dynamic conflict resolution content -->
            </div>
        </div>
    </div>

    <script>
        // Global State Management
        const AppState = {
            customers: [],
            buckets: [],
            conflicts: [],
            profitData: {
                goal: 0,
                projected: 0,
                gap: 0
            },
            progress: {
                assigned: 0,
                unassigned: 0,
                conflicts: 0
            }
        };

        // DOM Elements
        const Elements = {
            bucketsContainer: document.getElementById('bucketsContainer'),
            customersGrid: document.getElementById('customersGrid'),
            customerSearch: document.getElementById('customerSearch'),
            statusFilter: document.getElementById('statusFilter'),
            conflictsList: document.getElementById('conflictsList'),
            progressCircle: document.getElementById('progressCircle'),
            progressPercentage: document.getElementById('progressPercentage'),
            continueBtn: document.getElementById('continueBtn')
        };

        // CustomerAnalyticsEngine - Process historical data
        class CustomerAnalyticsEngine {
            static analyzeCustomers(historicalData) {
                // Extract customer data from historical sales
                const customerMap = new Map();
                
                // Process historical data to generate customer metrics
                historicalData.forEach(record => {
                    if (!customerMap.has(record.customerId)) {
                        customerMap.set(record.customerId, {
                            customerId: record.customerId,
                            customerName: record.customerName,
                            totalVolume: 0,
                            totalRevenue: 0,
                            totalProfit: 0,
                            deliveryCount: 0,
                            lastOrderDate: null,
                            bucketId: null
                        });
                    }
                    
                    const customer = customerMap.get(record.customerId);
                    customer.totalVolume += record.volume;
                    customer.totalRevenue += record.revenue;
                    customer.totalProfit += record.profit;
                    customer.deliveryCount += 1;
                    customer.lastOrderDate = new Date(Math.max(
                        customer.lastOrderDate ? customer.lastOrderDate.getTime() : 0,
                        new Date(record.date).getTime()
                    ));
                });
                
                // Calculate derived metrics
                return Array.from(customerMap.values()).map(customer => ({
                    ...customer,
                    averageUnitPrice: customer.totalVolume > 0 ? customer.totalRevenue / customer.totalVolume : 0,
                    profitMargin: customer.totalRevenue > 0 ? (customer.totalProfit / customer.totalRevenue) * 100 : 0,
                    averageOrderSize: customer.deliveryCount > 0 ? customer.totalVolume / customer.deliveryCount : 0
                }));
            }
            
            static generateCustomerRankings(customers, criteria = 'volume') {
                return customers.slice().sort((a, b) => {
                    switch (criteria) {
                        case 'volume':
                            return b.totalVolume - a.totalVolume;
                        case 'revenue':
                            return b.totalRevenue - a.totalRevenue;
                        case 'profit':
                            return b.totalProfit - a.totalProfit;
                        case 'margin':
                            return b.profitMargin - a.profitMargin;
                        default:
                            return 0;
                    }
                });
            }
        }

        // CustomerBucketManager - Handle bucket operations
        class CustomerBucketManager {
            static createBucket(bucketData) {
                const bucket = {
                    bucketId: `bucket-${Date.now()}`,
                    bucketName: bucketData.name,
                    criteria: {
                        volumeMin: bucketData.volumeMin || 0,
                        volumeMax: bucketData.volumeMax || null,
                        priceMin: bucketData.priceMin || 0,
                        priceMax: bucketData.priceMax || null,
                        profitMarginMin: bucketData.marginMin || -100,
                        profitMarginMax: bucketData.marginMax || null
                    },
                    assignedCustomers: [],
                    customerCount: 0,
                    totalVolume: 0,
                    averagePrice: 0,
                    averageMargin: 0,
                    adjustments: {
                        priceAdjustment: bucketData.priceAdjustment || 0,
                        adjustmentType: 'absolute'
                    }
                };
                
                AppState.buckets.push(bucket);
                this.updateBucketStatistics(bucket.bucketId);
                return bucket;
            }
            
            static validateBucketCriteria(criteria) {
                // Ensure criteria ranges are logical
                if (criteria.volumeMax !== null && criteria.volumeMin > criteria.volumeMax) {
                    return { valid: false, message: "Volume minimum cannot be greater than maximum" };
                }
                if (criteria.priceMax !== null && criteria.priceMin > criteria.priceMax) {
                    return { valid: false, message: "Price minimum cannot be greater than maximum" };
                }
                if (criteria.profitMarginMax !== null && criteria.profitMarginMin > criteria.profitMarginMax) {
                    return { valid: false, message: "Margin minimum cannot be greater than maximum" };
                }
                return { valid: true };
            }
            
            static assignCustomerToBucket(customerId, bucketId) {
                // Remove from all buckets first
                this.removeCustomerFromAllBuckets(customerId);
                
                const bucket = AppState.buckets.find(b => b.bucketId === bucketId);
                const customer = AppState.customers.find(c => c.customerId === customerId);
                
                if (bucket && customer) {
                    bucket.assignedCustomers.push(customerId);
                    customer.bucketId = bucketId;
                    this.updateBucketStatistics(bucketId);
                    this.updateProgress();
                    return true;
                }
                return false;
            }
            
            static removeCustomerFromAllBuckets(customerId) {
                const customer = AppState.customers.find(c => c.customerId === customerId);
                if (customer && customer.bucketId) {
                    const bucket = AppState.buckets.find(b => b.bucketId === customer.bucketId);
                    if (bucket) {
                        bucket.assignedCustomers = bucket.assignedCustomers.filter(id => id !== customerId);
                        this.updateBucketStatistics(bucket.bucketId);
                    }
                    customer.bucketId = null;
                }
                this.updateProgress();
            }
            
            static updateBucketStatistics(bucketId) {
                const bucket = AppState.buckets.find(b => b.bucketId === bucketId);
                if (!bucket) return;
                
                const assignedCustomers = AppState.customers.filter(c => c.bucketId === bucketId);
                
                bucket.customerCount = assignedCustomers.length;
                bucket.totalVolume = assignedCustomers.reduce((sum, c) => sum + c.totalVolume, 0);
                
                if (assignedCustomers.length > 0) {
                    const totalRevenue = assignedCustomers.reduce((sum, c) => sum + c.totalRevenue, 0);
                    bucket.averagePrice = bucket.totalVolume > 0 ? totalRevenue / bucket.totalVolume : 0;
                    bucket.averageMargin = assignedCustomers.reduce((sum, c) => sum + c.profitMargin, 0) / assignedCustomers.length;
                } else {
                    bucket.averagePrice = 0;
                    bucket.averageMargin = 0;
                }
            }
            
            static getCategorizationProgress() {
                const assigned = AppState.customers.filter(c => c.bucketId !== null).length;
                const total = AppState.customers.length;
                return total > 0 ? (assigned / total) * 100 : 0;
            }
            
            static getUnassignedCustomers() {
                return AppState.customers.filter(c => c.bucketId === null);
            }
            
            static updateProgress() {
                const assigned = AppState.customers.filter(c => c.bucketId !== null).length;
                const total = AppState.customers.length;
                const conflicts = AppState.conflicts.length;
                
                AppState.progress = {
                    assigned: assigned,
                    unassigned: total - assigned,
                    conflicts: conflicts
                };
                
                updateProgressDisplay();
            }
        }

        // OverlapResolutionEngine - Handle conflicts
        class OverlapResolutionEngine {
            static detectOverlaps() {
                AppState.conflicts = [];
                
                AppState.customers.forEach(customer => {
                    const eligibleBuckets = AppState.buckets.filter(bucket => 
                        this.customerMeetsCriteria(customer, bucket.criteria)
                    );
                    
                    if (eligibleBuckets.length > 1) {
                        const conflict = {
                            customerId: customer.customerId,
                            customerName: customer.customerName,
                            eligibleBuckets: eligibleBuckets.map(bucket => ({
                                bucketId: bucket.bucketId,
                                bucketName: bucket.bucketName,
                                matchScore: this.calculateMatchScore(customer, bucket)
                            })),
                            recommendedBucket: null,
                            conflictReason: `Customer meets criteria for ${eligibleBuckets.length} buckets`
                        };
                        
                        // Sort by match score and recommend the best fit
                        conflict.eligibleBuckets.sort((a, b) => b.matchScore - a.matchScore);
                        conflict.recommendedBucket = conflict.eligibleBuckets[0].bucketId;
                        
                        AppState.conflicts.push(conflict);
                    }
                });
                
                updateConflictsDisplay();
            }
            
            static customerMeetsCriteria(customer, criteria) {
                // Check volume criteria
                if (customer.totalVolume < criteria.volumeMin) return false;
                if (criteria.volumeMax !== null && customer.totalVolume > criteria.volumeMax) return false;
                
                // Check price criteria
                if (customer.averageUnitPrice < criteria.priceMin) return false;
                if (criteria.priceMax !== null && customer.averageUnitPrice > criteria.priceMax) return false;
                
                // Check margin criteria
                if (customer.profitMargin < criteria.profitMarginMin) return false;
                if (criteria.profitMarginMax !== null && customer.profitMargin > criteria.profitMarginMax) return false;
                
                return true;
            }
            
            static calculateMatchScore(customer, bucket) {
                let score = 0;
                const criteria = bucket.criteria;
                
                // Volume score (0-0.4)
                const volumeRange = (criteria.volumeMax || 10000) - criteria.volumeMin;
                const volumePosition = (customer.totalVolume - criteria.volumeMin) / volumeRange;
                score += Math.min(0.4, Math.max(0, volumePosition * 0.4));
                
                // Price score (0-0.3)
                const priceRange = (criteria.priceMax || 500) - criteria.priceMin;
                const pricePosition = (customer.averageUnitPrice - criteria.priceMin) / priceRange;
                score += Math.min(0.3, Math.max(0, pricePosition * 0.3));
                
                // Margin score (0-0.3)
                const marginRange = (criteria.profitMarginMax || 100) - criteria.profitMarginMin;
                const marginPosition = (customer.profitMargin - criteria.profitMarginMin) / marginRange;
                score += Math.min(0.3, Math.max(0, marginPosition * 0.3));
                
                return Math.min(1.0, score);
            }
        }

        // PricingAdjustmentCalculator - Calculate impact
        class PricingAdjustmentCalculator {
            static calculateAdjustmentImpact() {
                let totalRevenueChange = 0;
                let totalProfitChange = 0;
                let customersAffected = 0;
                
                AppState.buckets.forEach(bucket => {
                    if (bucket.adjustments.priceAdjustment !== 0 && bucket.assignedCustomers.length > 0) {
                        const bucketImpact = this.calculateBucketImpact(bucket);
                        totalRevenueChange += bucketImpact.revenueChange;
                        totalProfitChange += bucketImpact.profitChange;
                        customersAffected += bucket.assignedCustomers.length;
                    }
                });
                
                return {
                    revenueChange: totalRevenueChange,
                    profitChange: totalProfitChange,
                    customersAffected: customersAffected,
                    goalAchievement: this.calculateGoalAchievement(totalProfitChange)
                };
            }
            
            static calculateBucketImpact(bucket) {
                const assignedCustomers = AppState.customers.filter(c => c.bucketId === bucket.bucketId);
                const priceAdjustment = bucket.adjustments.priceAdjustment;
                
                const volumeImpact = assignedCustomers.reduce((sum, c) => sum + c.totalVolume, 0);
                const revenueChange = volumeImpact * priceAdjustment;
                const profitChange = revenueChange; // Assuming price adjustment directly impacts profit
                
                return {
                    revenueChange: revenueChange,
                    profitChange: profitChange,
                    volumeAffected: volumeImpact
                };
            }
            
            static calculateGoalAchievement(profitIncrease) {
                if (AppState.profitData.gap <= 0) return 100;
                
                const newGap = AppState.profitData.gap - profitIncrease;
                const achievement = Math.max(0, (1 - (newGap / AppState.profitData.gap)) * 100);
                return Math.min(100, achievement);
            }
        }

        // UI Functions
        function initializeStep5() {
            // Load data from previous steps (simulated)
            loadExistingData();
            
            // Initialize customer analytics
            AppState.customers = generateSampleCustomers();
            
            // Update displays
            updateProfitGapDisplay();
            updateCustomerAnalytics();
            updateCustomersGrid();
            updateBucketsDisplay();
            updateProgressDisplay();
            updatePricingImpact();
            
            // Set up event listeners
            setupEventListeners();
        }

        function loadExistingData() {
            // Load from localStorage or previous steps
            AppState.profitData = {
                goal: 125000,
                projected: 108000,
                gap: 17000
            };
        }

        function generateSampleCustomers() {
            // Generate sample customer data
            const customers = [
                {
                    customerId: 'cust-001',
                    customerName: 'ABC Construction',
                    totalVolume: 450.5,
                    averageUnitPrice: 125.00,
                    totalRevenue: 56312.50,
                    totalProfit: 12670.31,
                    profitMargin: 22.5,
                    averageOrderSize: 25.2,
                    deliveryCount: 18,
                    lastOrderDate: new Date('2024-01-15'),
                    bucketId: null
                },
                {
                    customerId: 'cust-002',
                    customerName: 'XYZ Builders',
                    totalVolume: 320.8,
                    averageUnitPrice: 118.50,
                    totalRevenue: 38014.80,
                    totalProfit: 7980.11,
                    profitMargin: 21.0,
                    averageOrderSize: 22.9,
                    deliveryCount: 14,
                    lastOrderDate: new Date('2024-02-20'),
                    bucketId: null
                },
                {
                    customerId: 'cust-003',
                    customerName: 'Premium Developers',
                    totalVolume: 680.2,
                    averageUnitPrice: 145.00,
                    totalRevenue: 98629.00,
                    totalProfit: 24657.25,
                    profitMargin: 25.0,
                    averageOrderSize: 34.0,
                    deliveryCount: 20,
                    lastOrderDate: new Date('2024-01-28'),
                    bucketId: null
                },
                {
                    customerId: 'cust-004',
                    customerName: 'Budget Builders',
                    totalVolume: 180.5,
                    averageUnitPrice: 95.00,
                    totalRevenue: 17147.50,
                    totalProfit: 2400.65,
                    profitMargin: 14.0,
                    averageOrderSize: 15.0,
                    deliveryCount: 12,
                    lastOrderDate: new Date('2024-02-05'),
                    bucketId: null
                },
                {
                    customerId: 'cust-005',
                    customerName: 'Midsize Projects',
                    totalVolume: 275.3,
                    averageUnitPrice: 112.00,
                    totalRevenue: 30833.60,
                    totalProfit: 6166.72,
                    profitMargin: 20.0,
                    averageOrderSize: 19.7,
                    deliveryCount: 14,
                    lastOrderDate: new Date('2024-02-12'),
                    bucketId: null
                }
            ];
            
            return customers;
        }

        function updateProfitGapDisplay() {
            const { goal, projected, gap } = AppState.profitData;
            
            document.getElementById('goalProfit').textContent = formatCurrency(goal);
            document.getElementById('projectedProfit').textContent = formatCurrency(projected);
            document.getElementById('profitGap').textContent = formatCurrency(Math.abs(gap));
            
            const percentage = goal > 0 ? (gap / goal) * 100 : 0;
            document.getElementById('gapPercentage').textContent = percentage.toFixed(1) + '%';
            
            // Update thermometer
            const fillPercentage = Math.min(100, Math.max(0, (projected / goal) * 100));
            document.getElementById('profitThermometerFill').style.height = fillPercentage + '%';
            
            // Update labels
            document.getElementById('goalLabel').textContent = `Goal: ${formatCurrency(goal)}`;
            document.getElementById('projectedLabel').textContent = `Projected: ${formatCurrency(projected)}`;
            document.getElementById('currentLabel').textContent = `Current: ${formatCurrency(projected)}`;
            
            // Update gap indicator
            const gapIndicator = document.getElementById('gapIndicator');
            const gapMessage = document.getElementById('gapMessage');
            
            if (gap > 0) {
                gapIndicator.className = 'gap-indicator deficit';
                gapMessage.textContent = `You need to increase profit by ${formatCurrency(gap)} to reach your goal`;
            } else if (gap < 0) {
                gapIndicator.className = 'gap-indicator surplus';
                gapMessage.textContent = `You're ${formatCurrency(Math.abs(gap))} above your profit goal!`;
            } else {
                gapIndicator.className = 'gap-indicator';
                gapMessage.textContent = 'You\'ve reached your profit goal!';
            }
        }

        function updateCustomerAnalytics() {
            const totalCustomers = AppState.customers.length;
            const avgVolume = AppState.customers.reduce((sum, c) => sum + c.totalVolume, 0) / totalCustomers;
            const avgPrice = AppState.customers.reduce((sum, c) => sum + c.averageUnitPrice, 0) / totalCustomers;
            const avgMargin = AppState.customers.reduce((sum, c) => sum + c.profitMargin, 0) / totalCustomers;
            const totalRevenue = AppState.customers.reduce((sum, c) => sum + c.totalRevenue, 0);
            const totalVolume = AppState.customers.reduce((sum, c) => sum + c.totalVolume, 0);
            
            document.getElementById('totalCustomers').textContent = totalCustomers;
            document.getElementById('avgVolume').textContent = avgVolume.toFixed(1);
            document.getElementById('avgPrice').textContent = formatCurrency(avgPrice);
            document.getElementById('avgMargin').textContent = avgMargin.toFixed(1) + '%';
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('totalVolumeStat').textContent = totalVolume.toFixed(1);
        }

        function updateCustomersGrid() {
            const container = Elements.customersGrid;
            const searchTerm = Elements.customerSearch.value.toLowerCase();
            const statusFilter = Elements.statusFilter.value;
            
            let filteredCustomers = AppState.customers.filter(customer => {
                const matchesSearch = customer.customerName.toLowerCase().includes(searchTerm);
                let matchesStatus = true;
                
                switch (statusFilter) {
                    case 'unassigned':
                        matchesStatus = customer.bucketId === null;
                        break;
                    case 'assigned':
                        matchesStatus = customer.bucketId !== null;
                        break;
                    case 'conflict':
                        matchesStatus = AppState.conflicts.some(c => c.customerId === customer.customerId);
                        break;
                }
                
                return matchesSearch && matchesStatus;
            });
            
            container.innerHTML = '';
            
            filteredCustomers.forEach(customer => {
                const isConflict = AppState.conflicts.some(c => c.customerId === customer.customerId);
                const statusClass = customer.bucketId ? 'assigned' : (isConflict ? 'conflict' : 'unassigned');
                const statusText = customer.bucketId ? 'Assigned' : (isConflict ? 'Conflict' : 'Unassigned');
                
                const card = document.createElement('div');
                card.className = `customer-card ${statusClass}`;
                card.draggable = true;
                card.dataset.customerId = customer.customerId;
                
                card.innerHTML = `
                    <div class="customer-header">
                        <div class="customer-name">${customer.customerName}</div>
                        <div class="assignment-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="customer-metrics">
                        <div class="customer-metric">
                            <div class="value">${customer.totalVolume.toFixed(1)}</div>
                            <div class="label">Volume (yd³)</div>
                        </div>
                        <div class="customer-metric">
                            <div class="value">${formatCurrency(customer.averageUnitPrice)}</div>
                            <div class="label">Avg Price</div>
                        </div>
                        <div class="customer-metric">
                            <div class="value">${customer.profitMargin.toFixed(1)}%</div>
                            <div class="label">Margin</div>
                        </div>
                    </div>
                `;
                
                // Add drag event listeners
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
                card.addEventListener('click', () => {
                    if (isConflict) {
                        showConflictResolution(customer.customerId);
                    }
                });
                
                container.appendChild(card);
            });
        }

        function updateBucketsDisplay() {
            const container = Elements.bucketsContainer;
            container.innerHTML = '';
            
            AppState.buckets.forEach(bucket => {
                const card = document.createElement('div');
                card.className = 'bucket-card';
                card.dataset.bucketId = bucket.bucketId;
                
                card.innerHTML = `
                    <div class="bucket-header">
                        <div class="bucket-name">${bucket.bucketName}</div>
                        <div class="bucket-actions">
                            <button class="bucket-action-btn" onclick="editBucket('${bucket.bucketId}')" title="Edit">✏️</button>
                            <button class="bucket-action-btn" onclick="deleteBucket('${bucket.bucketId}')" title="Delete">🗑️</button>
                        </div>
                    </div>
                    <div class="bucket-criteria">
                        Volume: ${bucket.criteria.volumeMin}${bucket.criteria.volumeMax ? `-${bucket.criteria.volumeMax}` : '+'} yd³ | 
                        Price: $${bucket.criteria.priceMin}${bucket.criteria.priceMax ? `-$${bucket.criteria.priceMax}` : '+'} | 
                        Margin: ${bucket.criteria.profitMarginMin}${bucket.criteria.profitMarginMax ? `-${bucket.criteria.profitMarginMax}` : '+'}%
                        ${bucket.adjustments.priceAdjustment !== 0 ? ` | Adjustment: ${bucket.adjustments.priceAdjustment > 0 ? '+' : ''}$${bucket.adjustments.priceAdjustment}` : ''}
                    </div>
                    <div class="bucket-stats">
                        <div class="bucket-stat">
                            <div class="value">${bucket.customerCount}</div>
                            <div class="label">Customers</div>
                        </div>
                        <div class="bucket-stat">
                            <div class="value">${bucket.totalVolume.toFixed(1)}</div>
                            <div class="label">Volume</div>
                        </div>
                        <div class="bucket-stat">
                            <div class="value">${formatCurrency(bucket.averagePrice)}</div>
                            <div class="label">Avg Price</div>
                        </div>
                    </div>
                `;
                
                // Add drop event listeners
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragenter', handleDragEnter);
                card.addEventListener('dragleave', handleDragLeave);
                
                container.appendChild(card);
            });
        }

        function updateProgressDisplay() {
            const progress = CustomerBucketManager.getCategorizationProgress();
            const { assigned, unassigned, conflicts } = AppState.progress;
            
            // Update progress ring
            const circumference = 2 * Math.PI * 50;
            const offset = circumference - (progress / 100) * circumference;
            Elements.progressCircle.style.strokeDashoffset = offset;
            Elements.progressPercentage.textContent = `${progress.toFixed(0)}%`;
            
            // Update progress details
            document.getElementById('assignedCount').textContent = assigned;
            document.getElementById('unassignedCount').textContent = unassigned;
            document.getElementById('conflictCount').textContent = conflicts;
            
            // Update continue button
            Elements.continueBtn.disabled = progress < 70;
        }

        function updateConflictsDisplay() {
            const container = Elements.conflictsList;
            
            if (AppState.conflicts.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; font-style: italic;">No conflicts detected</p>';
                return;
            }
            
            container.innerHTML = '';
            
            AppState.conflicts.forEach(conflict => {
                const item = document.createElement('div');
                item.className = 'conflict-item';
                
                item.innerHTML = `
                    <div class="conflict-customer">${conflict.customerName}</div>
                    <div>Eligible for ${conflict.eligibleBuckets.length} buckets</div>
                    <div class="conflict-options">
                        <button class="resolve-btn" onclick="showConflictResolution('${conflict.customerId}')">
                            Resolve
                        </button>
                        <button class="resolve-btn" onclick="autoResolveConflict('${conflict.customerId}')">
                            Auto
                        </button>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }

        function updatePricingImpact() {
            const impact = PricingAdjustmentCalculator.calculateAdjustmentImpact();
            
            document.getElementById('revenueChange').textContent = formatCurrency(impact.revenueChange);
            document.getElementById('profitChange').textContent = formatCurrency(impact.profitChange);
            document.getElementById('goalAchievement').textContent = impact.goalAchievement.toFixed(1) + '%';
            document.getElementById('customersAffected').textContent = impact.customersAffected;
            
            // Update classes for positive/negative changes
            const revenueEl = document.getElementById('revenueChange');
            const profitEl = document.getElementById('profitChange');
            
            revenueEl.className = impact.revenueChange >= 0 ? 'impact-value positive' : 'impact-value negative';
            profitEl.className = impact.profitChange >= 0 ? 'impact-value positive' : 'impact-value negative';
        }

        // Event Handlers
        function setupEventListeners() {
            Elements.customerSearch.addEventListener('input', debounce(updateCustomersGrid, 300));
            Elements.statusFilter.addEventListener('change', updateCustomersGrid);
        }

        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.customerId);
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDragEnter(e) {
            e.target.closest('.bucket-card').classList.add('active-drop-zone');
        }

        function handleDragLeave(e) {
            if (!e.target.closest('.bucket-card').contains(e.relatedTarget)) {
                e.target.closest('.bucket-card').classList.remove('active-drop-zone');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            const customerId = e.dataTransfer.getData('text/plain');
            const bucketId = e.target.closest('.bucket-card').dataset.bucketId;
            
            CustomerBucketManager.assignCustomerToBucket(customerId, bucketId);
            OverlapResolutionEngine.detectOverlaps();
            updateCustomersGrid();
            updateBucketsDisplay();
            updatePricingImpact();
            
            e.target.closest('.bucket-card').classList.remove('active-drop-zone');
        }

        // Modal Functions
        function showCreateBucketModal() {
            document.getElementById('createBucketModal').style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showBulkAssignModal() {
            const select = document.getElementById('bulkTargetBucket');
            select.innerHTML = '<option value="">Select a bucket...</option>';
            
            AppState.buckets.forEach(bucket => {
                const option = document.createElement('option');
                option.value = bucket.bucketId;
                option.textContent = bucket.bucketName;
                select.appendChild(option);
            });
            
            document.getElementById('bulkAssignModal').style.display = 'flex';
        }

        function showConflictResolution(customerId) {
            const conflict = AppState.conflicts.find(c => c.customerId === customerId);
            if (!conflict) return;
            
            const modal = document.getElementById('conflictModal');
            const content = document.getElementById('conflictContent');
            
            content.innerHTML = `
                <h4>${conflict.customerName}</h4>
                <p>This customer meets criteria for multiple buckets. Choose the best assignment:</p>
                <div style="margin: 20px 0;">
                    ${conflict.eligibleBuckets.map(bucket => `
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <strong>${bucket.bucketName}</strong>
                            <br>Match Score: ${(bucket.matchScore * 100).toFixed(0)}%
                            <br><button class="btn btn-primary" onclick="resolveConflict('${customerId}', '${bucket.bucketId}')">
                                Assign Here
                            </button>
                        </div>
                    `).join('')}
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModal('conflictModal')">Cancel</button>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        function resolveConflict(customerId, bucketId) {
            CustomerBucketManager.assignCustomerToBucket(customerId, bucketId);
            OverlapResolutionEngine.detectOverlaps();
            updateCustomersGrid();
            updateBucketsDisplay();
            updatePricingImpact();
            closeModal('conflictModal');
        }

        function autoResolveConflict(customerId) {
            const conflict = AppState.conflicts.find(c => c.customerId === customerId);
            if (conflict && conflict.recommendedBucket) {
                resolveConflict(customerId, conflict.recommendedBucket);
            }
        }

        function executeBulkAssign() {
            const bucketId = document.getElementById('bulkTargetBucket').value;
            if (!bucketId) return;
            
            const unassigned = CustomerBucketManager.getUnassignedCustomers();
            unassigned.forEach(customer => {
                CustomerBucketManager.assignCustomerToBucket(customer.customerId, bucketId);
            });
            
            OverlapResolutionEngine.detectOverlaps();
            updateCustomersGrid();
            updateBucketsDisplay();
            updatePricingImpact();
            closeModal('bulkAssignModal');
        }

        // Form Handlers
        document.getElementById('createBucketForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const bucketData = {
                name: document.getElementById('bucketName').value,
                volumeMin: parseFloat(document.getElementById('volumeMin').value) || 0,
                volumeMax: parseFloat(document.getElementById('volumeMax').value) || null,
                priceMin: parseFloat(document.getElementById('priceMin').value) || 0,
                priceMax: parseFloat(document.getElementById('priceMax').value) || null,
                marginMin: parseFloat(document.getElementById('marginMin').value) || -100,
                marginMax: parseFloat(document.getElementById('marginMax').value) || null,
                priceAdjustment: parseFloat(document.getElementById('priceAdjustment').value) || 0
            };
            
            // Validate criteria
            const validation = CustomerBucketManager.validateBucketCriteria({
                volumeMin: bucketData.volumeMin,
                volumeMax: bucketData.volumeMax,
                priceMin: bucketData.priceMin,
                priceMax: bucketData.priceMax,
                profitMarginMin: bucketData.marginMin,
                profitMarginMax: bucketData.marginMax
            });
            
            if (!validation.valid) {
                alert(validation.message);
                return;
            }
            
            CustomerBucketManager.createBucket(bucketData);
            OverlapResolutionEngine.detectOverlaps();
            updateBucketsDisplay();
            updatePricingImpact();
            
            e.target.reset();
            closeModal('createBucketModal');
        });

        // Utility Functions
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function goToStep(stepNumber) {
            // Navigation logic - would integrate with main application
            console.log(`Navigate to step ${stepNumber}`);
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeStep5);
    </script>
</body>
</html>